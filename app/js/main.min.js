const baseUrl="http://localhost:8888/";let junctionsUrl=baseUrl+"junctions/",routesUrl="routes_count/",routesArr=[],mapUrl="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",mapLayer=new L.TileLayer(mapUrl,{maxZoom:18,minZoom:10}),baseMaps={"Moscow junctions":mapLayer},map=new L.Map("map",{center:new L.LatLng(55.719,37.5774),zoom:10,layers:[mapLayer]}),markersLayer=new L.LayerGroup;map.addLayer(markersLayer);let list=new L.Control.RoutesCountColor({layer:markersLayer});map.addControl(list);let info=new L.Control.MarkerInfo({layer:markersLayer});map.addControl(info);class Junction{constructor(t=Number,e=String,r=Number,o=Number,a=Number,n=Number){this.id=t,this.name=e,this.latitude=r,this.longitude=o,this.radius=a,this.maxRoutes=n}getRoutesCount=async()=>{const t=await fetch(junctionsUrl+this.id+"/"+routesUrl);return await t.json()};getRoutesRatio=async(t=Number)=>t/this.maxRoutes;getIconColor=async(t=Number)=>.5==t?"#ffff00":t>.9?"#00ff00":t>.8?"#33ff00":t>.7?"#66ff00":t>.6?"#99ff00":t>.5?"#ccff00":t>.4?"#ffcc00":t>.3?"#ff9900":t>.2?"#ff6600":t>.1?"#ff3300":"#ff0000";addMarkerIcon=async t=>{let e=`background-color: ${t}`;return L.divIcon({className:"map-pin",popupAnchor:[0,-30],html:`<span style="${e}" />`})};addMarker=async t=>{this.getRoutesCount().then(t=>this.getRoutesRatio(t)).then(t=>this.getIconColor(t)).then(t=>this.addMarkerIcon(t)).then(e=>{let r=L.marker([this.longitude,this.latitude],{name:this.name,routes:t,maxRoutes:this.maxRoutes,radius:this.radius});r.setIcon(e).addTo(markersLayer).bindPopup("Развязка № "+this.id);let o=!1;r.on("click",(function(t){o&&map.removeLayer(o),o=L.circle(t.target.getLatLng(),{radius:this.options.radius,color:"#ff0000"}).addTo(map)})),r.on("popupclose",(function(t){map.removeLayer(o)}))})}}async function getJunctions(){const t=await fetch(junctionsUrl);let e=await t.json();for(let t=1;t<=e.length;t++){const e=await fetch(junctionsUrl+t+"/"+routesUrl);let r=await e.json();routesArr.push(r)}i=0,routesArr.sort((function(t,e){return e-t}));let r=routesArr[0];for(let t in e){let o=new Junction(e[t].id,e[t].name,e[t].longitude,e[t].latitude,e[t].radius,r);o.getRoutesCount().then(t=>o.addMarker(t).then(t=>t))}}getJunctions();