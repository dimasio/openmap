const baseUrl="http://localhost:8888/";let junctionsUrl=baseUrl+"junctions/",routesUrl="routes_count/",mapUrl="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",mapLayer=new L.TileLayer(mapUrl,{maxZoom:18,minZoom:10}),baseMaps={"Moscow junctions":mapLayer},map=new L.Map("map",{center:new L.LatLng(55.719,37.5774),zoom:10,layers:[mapLayer]}),markersLayer=new L.LayerGroup;map.addLayer(markersLayer);let list=new L.Control.ListMarkers({layer:markersLayer});map.addControl(list);class Junction{constructor(t=Number,e=String,r=Number,o=Number){this.id=t,this.name=e,this.latitude=r,this.longitude=o}getRoutesInfo=async()=>{const t=await fetch(junctionsUrl+this.id+"/"+routesUrl);return await t.json()};getRoutesRatio=async(t,e)=>t/e;getColor=async t=>.5==t?"#ffff00":t>.9?"#00ff00":t>.8?"#33ff00":t>.7?"#66ff00":t>.6?"#99ff00":t>.5?"#ccff00":t>.4?"#ffcc00":t>.3?"#ff9900":t>.2?"#ff6600":t>.1?"#ff3300":"#ff0000";addMarker(t){let e=L.marker([this.longitude,this.latitude],{junction:this.name}).setIcon(t).addTo(markersLayer).bindPopup(this.name),r=!1;return e.on("click",(function(t){r&&map.removeLayer(r),r=L.circle(t.target.getLatLng(),{radius:350,color:"#ff0000"}).addTo(map)})),e.on("popupclose",(function(t){map.removeLayer(r)})),e}}function getGradValue(t){return.5==t?5:t>.9?0:t>.8?1:t>.7?2:t>.6?3:t>.5?4:t>.4?6:t>.3?7:t>.2?8:t>.1?9:10}async function getJunctions(){const t=await fetch(junctionsUrl);let e=await t.json(),r=e.length;for(let t=1;t<=r;t++){const e=await fetch(junctionsUrl+t+"/"+routesUrl);let r=await e.json();routesArr.push(r)}i=0,routesArr.sort((function(t,e){return e-t}));let o=routesArr[0],n=L.control({position:"topright"});n.onAdd=function(t){let e,r,n,a=L.DomUtil.create("div","info legend"),s=(L.DomUtil.create("div","routes-gradient",a),L.DomUtil.create("div","routes-count",a)),u=[],l=Array.from(new Set(routesArr));for(i=0;i<=10;i++)u[i]="<i></i>";if(i=0,u[10]="<i>0</i>",l.length<=10){for(i=0;i<l.length;i++)e=l[i]/o,r=getGradValue(e),u[r]="<i>"+l[i]+"</i>";i=0}else{for(n=Math.round(l.length/9),u[0]="<i>"+o+"</i>",i=1;i<10;i++)l.includes(l[i*n-1],0)&&0!=l[i*n-1]&&(e=l[i*n-1]/o,r=getGradValue(e),u[r]="<i>"+l[i*n-1]+"</i>");i=0}return s.innerHTML=u.join(""),a},n.addTo(map);for(let t in e){let r=new Junction(e[t].id,e[t].name,e[t].longitude,e[t].latitude);r.getRoutesInfo().then(t=>(routesRatio=r.getRoutesRatio(t,o),routesRatio)).then(t=>r.getColor(t)).then(t=>{let e=`background-color: ${t}`;return L.divIcon({className:"map-pin",popupAnchor:[0,-30],html:`<span style="${e}" />`})}).then(t=>r.addMarker(t))}}routesArr=[],getJunctions();